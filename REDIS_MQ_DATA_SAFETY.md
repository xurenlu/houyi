# Redis MQ 数据安全说明

## 📊 数据丢失风险分析

使用 Redis 作为消息队列确实存在数据丢失的风险，主要体现在以下几个方面：

### 1. Redis 持久化风险

**风险点**：
- Redis 是内存数据库，数据存储在内存中
- 如果 Redis 崩溃且没有持久化，内存中的数据会丢失
- 即使有持久化，也可能丢失最后一次持久化到崩溃之间的数据

**当前状态**：
- ✅ **RDB 持久化已启用**：定期快照（save 3600 1 300 100 60 10000）
- ✅ **AOF 持久化已启用**：appendonly yes，appendfsync everysec
- ⚠️ **风险**：最多可能丢失 1 秒的数据（AOF everysec 模式）

### 2. Redis 内存限制风险

**风险点**：
- 如果 Redis 内存满了，新消息可能无法写入
- 如果配置了淘汰策略，可能会删除旧消息

**当前状态**：
- ✅ **maxmemory 未设置**：使用服务器全部可用内存
- ✅ **maxmemory-policy: noeviction**：内存满时不淘汰数据，拒绝写入
- ⚠️ **风险**：如果内存满了，新消息会发送失败

### 3. 网络和连接风险

**风险点**：
- 网络中断时，消息可能发送失败
- Redis 连接断开时，消息可能丢失

**当前状态**：
- ✅ **连接池配置**：使用 Lettuce 连接池
- ✅ **异常处理**：发送失败会抛出异常，业务层可以重试
- ⚠️ **风险**：如果异常未被捕获，消息可能丢失

## 🛡️ 数据安全保障措施

### 1. 消息备份机制（已实现）

**功能**：
- 所有发送到 Redis Stream 的普通消息都会备份到数据库 `redis_message_backup` 表
- 延迟消息本身就存储在数据库 `delay_message` 表中
- 消息消费确认后，备份记录会被标记为已确认

**配置**：
```yaml
redis:
  mq:
    enable-message-backup: true  # 默认启用，建议生产环境保持启用
```

**优势**：
- ✅ 即使 Redis 数据丢失，也可以从数据库恢复
- ✅ 可以追踪消息的发送和消费状态
- ✅ 支持消息重发（从备份恢复）

### 2. Redis 持久化配置（已优化）

**当前配置**：
- **RDB**：定期快照，保存到磁盘
- **AOF**：追加日志，每秒同步一次（everysec）
- **持久化目录**：`/var/lib/redis/`（默认）

**建议**：
- 定期检查 AOF 文件大小，避免过大
- 考虑使用 `appendfsync always`（性能较低但更安全）
- 定期备份 Redis 数据文件

### 3. 延迟消息数据库存储（已实现）

**功能**：
- 所有延迟消息都存储在数据库 `delay_message` 表中
- 由 `RedisDelayMessageProcessor` 定期扫描并投递
- 即使 Redis 崩溃，延迟消息也不会丢失

### 4. 消息消费确认机制（已实现）

**功能**：
- 使用 Redis Stream 的 ACK 机制
- 只有处理成功的消息才会发送 ACK
- 处理失败的消息会保留在 Stream 中，等待重试

## 📈 数据丢失风险评估

### 低风险场景 ✅

1. **延迟消息**：存储在数据库，风险极低
2. **已备份的普通消息**：即使 Redis 丢失，可以从数据库恢复
3. **已消费确认的消息**：已经处理完成，不影响业务

### 中风险场景 ⚠️

1. **未备份的普通消息**（如果禁用了备份）：
   - 如果 Redis 崩溃，可能丢失
   - 建议：保持 `enable-message-backup: true`

2. **Redis 内存满**：
   - 新消息无法写入
   - 建议：监控 Redis 内存使用，设置告警

3. **网络中断**：
   - 消息发送失败，但会抛出异常
   - 建议：业务层实现重试机制

### 高风险场景 ❌

1. **Redis 崩溃且 AOF 未同步**：
   - 最多丢失 1 秒的数据（everysec 模式）
   - 如果使用 always 模式，性能会下降

2. **数据库和 Redis 同时故障**：
   - 备份机制失效
   - 建议：定期备份数据库

## 🔧 最佳实践建议

### 1. 生产环境配置

```yaml
redis:
  mq:
    enabled: true
    enable-message-backup: true  # 必须启用
```

### 2. Redis 配置优化

```bash
# 启用 AOF（已配置）
appendonly yes
appendfsync everysec  # 或 always（更安全但性能较低）

# 设置内存限制和告警
maxmemory 2gb
maxmemory-policy noeviction
```

### 3. 监控和告警

- 监控 Redis 内存使用率
- 监控 Redis Stream 长度
- 监控消息备份表大小
- 设置告警阈值

### 4. 定期备份

- 定期备份 Redis 数据文件（RDB + AOF）
- 定期备份数据库（包括消息备份表）
- 测试恢复流程

## 📊 数据恢复方案

### 场景 1：Redis 数据丢失，但备份表完整

1. 从 `redis_message_backup` 表查询未确认的消息
2. 重新发送到 Redis Stream
3. 恢复业务

### 场景 2：Redis 和数据库都丢失

1. 从数据库备份恢复
2. 检查 `redis_message_backup` 表中的未确认消息
3. 重新发送到 Redis Stream

### 场景 3：部分消息丢失

1. 检查 Redis Stream 中的消息
2. 检查备份表中的消息
3. 对比差异，补发缺失的消息

## 🎯 总结

**数据丢失风险**：
- ⚠️ **存在风险**，但已通过多种机制降低风险
- ✅ **延迟消息**：存储在数据库，风险极低
- ✅ **普通消息**：通过备份机制，风险可控
- ⚠️ **极端情况**：Redis 和数据库同时故障，风险较高

**建议**：
1. ✅ **保持消息备份启用**（默认已启用）
2. ✅ **监控 Redis 内存和持久化状态**
3. ✅ **定期备份数据库和 Redis 数据**
4. ✅ **设置告警机制**
5. ⚠️ **考虑使用 Redis 主从复制**（进一步提高可用性）

**与 RocketMQ 对比**：
- RocketMQ：消息持久化到磁盘，数据丢失风险较低
- Redis MQ：通过数据库备份机制，风险可控，但需要额外存储空间

